name: AI-Driven Development

on:
  issues:
    types: [ labeled ]   # Trigger when 'ai-implement' label is added to an issue

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-implement:
    name: AI implements issue
    runs-on: ubuntu-22.04
    if: contains(github.event.label.name, 'ai-implement')
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Claude SDK
        run: pip install anthropic

      - name: Generate implementation
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ISSUE_TITLE:  ${{ github.event.issue.title }}
          ISSUE_BODY:   ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 - <<'EOF'
          import anthropic
          import os
          import json

          client = anthropic.Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])

          issue_title  = os.environ["ISSUE_TITLE"]
          issue_body   = os.environ["ISSUE_BODY"]
          issue_number = os.environ["ISSUE_NUMBER"]

          system = """You are a CircleOS Android 14 developer.
          CircleOS is a privacy-first AOSP fork. Key components:
          - frameworks/base: privacy services (com.circleos.server.privacy.*)
          - vendor/circle: build config, SELinux, kernel hardening
          - packages/apps/CircleSettings: privacy UI
          - build/circle: lunch targets

          When given a feature request or bug report, output ONLY a JSON array of file operations:
          [{"path": "relative/path/file.java", "action": "create|modify", "content": "..."}]
          Follow existing code patterns exactly. Use Apache-2.0 SPDX header on all new files."""

          prompt = f"""Issue #{issue_number}: {issue_title}

          {issue_body}

          Implement this change. Output JSON file operations only."""

          message = client.messages.create(
              model="claude-opus-4-6",
              max_tokens=8096,
              system=system,
              messages=[{"role": "user", "content": prompt}]
          )

          response = message.content[0].text

          # Write response for next step
          with open("ai_response.json", "w") as f:
              f.write(response)

          print(f"Generated response ({len(response)} chars)")
          EOF

      - name: Apply generated changes
        run: |
          python3 - <<'EOF'
          import json, os

          with open("ai_response.json") as f:
              content = f.read().strip()

          # Extract JSON if wrapped in markdown
          if "```json" in content:
              content = content.split("```json")[1].split("```")[0].strip()
          elif "```" in content:
              content = content.split("```")[1].split("```")[0].strip()

          operations = json.loads(content)

          for op in operations:
              path    = op["path"]
              action  = op.get("action", "create")
              text    = op.get("content", "")
              os.makedirs(os.path.dirname(path) if os.path.dirname(path) else ".", exist_ok=True)
              with open(path, "w") as f:
                  f.write(text)
              print(f"{action}: {path}")
          EOF

      - name: Create branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE:  ${{ github.event.issue.title }}
        run: |
          BRANCH="ai/issue-${ISSUE_NUMBER}"
          git config user.email "ci@circleos.org"
          git config user.name  "CircleOS AI"
          git checkout -b "$BRANCH"
          git add -A
          git diff --cached --stat
          git commit -m "AI: implement #${ISSUE_NUMBER} â€” ${ISSUE_TITLE}"
          git push origin "$BRANCH"
          gh pr create \
            --title "AI: ${ISSUE_TITLE}" \
            --body "Resolves #${ISSUE_NUMBER}. Generated by CircleOS AI pipeline." \
            --base main \
            --head "$BRANCH" \
            --label "ai-generated"
